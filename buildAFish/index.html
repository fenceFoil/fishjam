<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <link rel="icon" href="favicon.ico">
    <link rel="stylesheet" href="normalize.css">
    <title>Tasty Fish</title>

    <noscript>Hello Ryan! Behold the fallback fish: üêü</noscript>
    <link rel="stylesheet" href="main.css">
    <style>
     #fishbox {
     } 
    </style>
</head>
<body>
    <div id="app" x-data="d">
        <!-- üêü üé£üê†üê°ü¶àüê≥üíßüåøü¶ëüêô -->
        <canvas id="fishbox" width="500" height="500" tabindex='0' :style="{filter: 'invert('+currFilter+')'}"></canvas>
        <!--<canvas id="fishbox" width="500" height="500" tabindex='0' :style="{filter: 'invert('+currFilter+')'}"></canvas> -->
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="alpine.3.9.6.min.js" defer></script>
    <script src="lodash.min.js"></script>
    <script src="chance.min.js"></script>
    <script type="text/javascript" src="voronoijs.min.js"></script>
    <script>

         document.addEventListener('alpine:init', () => {
             Alpine.data('d', () => ({
                 currFilter: 0,

                 async init() {
                     setInterval(() => {
                         //this.currFilter = (Math.sin(Date.now()/10000)+1)/2
                         console.log(this.currFilter);
                     }, 100);
                 }
             }))
         });
        
        $(document).ready(function() {
            var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
            window.requestAnimationFrame = requestAnimationFrame;
            var canvas = document.getElementById("fishbox");
            var context = canvas.getContext("2d");
            console.log("Game started...")
            loop();
        })
        

        var curKeyPress = {};

        var balls = []
        var numBalls = 10

        var healthBar = {
            x: 20,
            y: 20,
            width: 150,
            height: 30,
            draw: function(context) {
                // Outer Rectangle outline
                context.save();
                context.strokeWidth = 3;
                context.strokeRect(this.x, this.y, this.width, this.height);
                context.restore();

                // Inner Rectangle health bar
                context.save();
                context.fillStyle = 'red';
                context.fillRect(this.x+1, this.y+1, (this.width-2) * (ball.health / 100), this.height-2);
                context.restore();
            }
        }

        var colors = ['dodgerblue', 'green', 'yellow', 'black', 'red', 'purple', 'pink']
        var fish_colors = ['fish_brown', 'fish_cyan', 'fish_green', 'fish_red', 'fish_purple', 'fish_black']

        for(let i = 0; i < numBalls; i=1+i) {
            spawnEnemyFishBall();
        }

        function spawnEnemyFishBall() {
            let fish_img = new Image();
            fish_img.onload = function() {
                new_fish = {
                    x: Math.floor(Math.random() * 500),
                    y: Math.floor(Math.random() * 500),
                    radius: Math.floor(Math.random() * 20),
                    velX: 0,
                    velY: 0,
                    img: fish_img,
                    draw: function(context) {
                        context.drawImage(fish_img, this.x, this.y);
                    }
                }
                balls.push(new_fish);
            };
            fish_img.onerror = function() {
                console.log("Error loading fish image");
            };
            fish_img.src = "./resources/images/" + fish_colors[Math.floor(Math.random() * fish_colors.length)] + ".png";
            /*balls.push(
                {
                    x: Math.floor(Math.random() * 500),
                    y: Math.floor(Math.random() * 500),
                    radius: Math.floor(Math.random() * 20),
                    velX: 0,
                    velY: 0,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    draw: function(context) {
                        context.beginPath();
                        context.arc(this.x, this.y, this.radius, 0, Math.PI * 2, true);
                        context.closePath();
                        context.fillStyle = this.color;
                        context.fill();
                    }
                }
            )*/
        }
        
        var ball = {draw: function(){}};
        let fish_img = new Image();
        fish_img.onload = function() {
            ball = {
                x: 50,
                y: 50,
                radius: 20,
                velX: 0,
                velY: 0,
                health: 25,
                plastic: 2,
                img: fish_img,
                draw: function(context) {
                    context.drawImage(fish_img, this.x, this.y, this.img.width*(this.radius/20), this.img.height*(this.radius/20));
                }
            }
            balls.push(new_fish);
        };
        fish_img.onerror = function() {
            console.log("Error loading fish image");
        };
        fish_img.src = "./resources/images/fish_1_cropped_32_x_32.png";
        
        // var ball = {
        //     x: 50,
        //     y: 50,
        //     radius: 20,
        //     velX: 0,
        //     velY: 0,
        //     health: 75,
        //     plastic: 2,
        //     color: 'green',
        //     draw: function(context) {
        //         //context.beginPath();
        //         //context.arc(this.x, this.y, this.radius, 0, Math.PI * 2, true);
        //         //context.closePath();
        //         //context.fillStyle = this.color;
        //         //context.fill();
        //         context.font = this.radius*2+'px serif';
        //         context.fillText('ü¶ê', this.x, this.y);
        //     }
        // }
        

        $(document).on('keydown', function(e) {
            curKey = String.fromCharCode(e.which)
            curKeyPress[curKey.toLowerCase()] = true;
        })

        $(document).on("keyup", function(e) {
            curKey = String.fromCharCode(e.which)
            curKeyPress[curKey.toLowerCase()] = false;
        })

        function updateKeyStatus() {
            if(curKeyPress['w']){
                ball.velY = -1.5;
            }
            else if(curKeyPress['s']) {
                ball.velY = 1.5;
            }
            else {
                ball.velY = 0;
            }
            if(curKeyPress['a']) {
                ball.velX = -1.5;
            }
            else if(curKeyPress['d']) {
                ball.velX = 1.5;
            }
            else {
                ball.velX = 0;
            }
        }
        
        function loop() {
            updateKeyStatus();
            var canvas = document.getElementById("fishbox");
            var context = canvas.getContext("2d");
            
            context.clearRect(0,0, canvas.width, canvas.height);
            
            var deltaX = ball.velX
            var deltaY = ball.velY
            
            //console.log(curKeyPress)
            
            ball.x += deltaX;
            ball.y += deltaY;

            // Spawn food occasionally
            if(Math.random() < 0.005) // Value determined at random
            // https://chancejs.com/
            {
                console.log("FOOD");
                addFood();
            }

            if(ball.plastic > 0) {
                // /60 to make it per second probably
                ball.health -= (ball.plastic * 2) / 60;

                if(Math.random() < 0.0045) {
                    ball.plastic = ball.plastic - 1;
                }
            }

            if(ball.health <= 0) {
                context.save();
                context.font = 46+'px serif';
                context.fillText('The Ocean is DEAD', 20, 275);
                context.restore();
            }

            for(let i = 0; i < food.length; i++)
            {
                if (isColliding(food[i], ball)) {
                    if(food[i].isSafe) {
                        ball.health = ball.health + 5;
                        ball.radius *= 1.2;
                    }
                    else {
                        ball.plastic = ball.plastic + 1;
                    }
                    foog = food.splice(i, 1);
                    i = i - 1;
                }
                else {
                    food[i].draw(context)
                }
            }
            
            ball.draw(context);

            for (let i = 0; i < balls.length; i++) {

                var enemyBallNearbyThresh = 200;
                
                // throttle below values to test ball movement
                // must sum to 1
                var weight_boid = 0.6
                var weight_player = getDist(ball, balls[i]) <= enemyBallNearbyThresh ? 1 : 0.4;

                // calculating Boid vector
                var ballsNearby = getBallsWithinThreshDist(ball, balls, i, 150)

                var totalX = 0
                var totalY = 0

                for (let j = 0; j < ballsNearby.length; j++) {
                    totalX += ballsNearby[j].x
                    totalY += ballsNearby[j].y
                }

                var averageX = (totalX / (ballsNearby.length == 0 ? 1 : ballsNearby.length))
                var averageY = (totalY / (ballsNearby.length == 0 ? 1 : ballsNearby.length))
                
                var deltaXBoid = averageX * 0.005 * weight_boid
                var deltaYBoid = averageY * 0.005 * weight_boid

                // calculating vector to target player ball
                var deltaXPlayer = ((ball.x - balls[i].x) * 0.005) * weight_player
                var deltaYPlayer = ((ball.y - balls[i].y) * 0.005) * weight_player
                
                var deltaX = deltaXBoid + deltaXPlayer
                var deltaY = deltaYBoid + deltaYPlayer
                
                if (balls[i].x < 0 || balls[i].x > canvas.width || balls[i].y < 0 || balls[i].y > canvas.height) {
                    balls[i].velX = balls[i].velX * -1
                    balls[i].velY = balls[i].velY * -1
                    balls[i].x += balls[i].velX
                    balls[i].y += balls[i].velY
                } else {
                    balls[i].x += deltaX
                    balls[i].y += deltaY
                }
                balls[i].draw(context)

            }

            healthBar.draw(context);

            requestAnimationFrame(loop);
        }
        
    
        var fishes = []
        var food = []
        //addFish('./resources/images/fish_1_cropped.png');
        addFood();
        addFood();
        addFood();
        addFood();
        addFood();
        addFood();

        function addFood() {
            new_food = {
                x: Math.floor((Math.random() * 500)),
                y: Math.floor((Math.random() * 500)),
                color: 'brown',
                radius: 5,
                isSafe: (Math.random() > 0.4),
                draw: function(context) {
                    /*context.beginPath();
                    context.arc(this.x, this.y, this.radius, 0, Math.PI * 2, true);
                    context.closePath();
                    context.fillStyle = this.color;
                    context.fill();*/
                   context.font = this.radius*2+'px serif';
                   context.fillText('ü¶ê', this.x, this.y);
                }
            }
            food.push(new_food);
        }

        function getDist(b1, b2) {
            return Math.sqrt(Math.pow(b1.x - b2.x, 2) + Math.pow(b1.y - b2.y, 2))
        }

        function getBallsWithinThreshDist(org, balls, curBallIdx, thresh) {
            var ret = []
            for (var i = 0; i < balls.length; i++) {
                if (getDist(org, balls[i]) <= thresh && i != curBallIdx) {
                    ret.push(balls[i])
                }
            }
            return ret
        }

        function addFish(fishImg) {
            fish_img = new Image();
            fish_img.onload = function() {
                new_fish = {
                    x: 100,
                    y: 100,
                    img: fishImg,
                    draw: function() {
                        context.drawImage(fish_img, this.x, this.y);
                    }
                }
                fishes.push(new_fish);
            };
            fish_img.onerror = function() {
                console.log("Error loading fish image");
            };
            fish_img.src = fishImg;
        }

        // Assumes everything is a circle with a radius attribute and x/y coordinates
        function isColliding(obj1, obj2) {
            let sqrDistance = sqrDist(obj1, obj2);
            let combinedRadius = obj1.radius + obj2.radius;
            // A^2 + B^2 = C^2
            // Get the square distance between two objects (C^2)
            // Then see if it's larger than the combined object radiuses squared
            if(sqrDistance < (combinedRadius * combinedRadius)) {
                return true;
            }
            return false;
        }

        // Gets the squared distance between two objects
        // A^2 + B^2 = C^2
        function sqrDist(obj1, obj2) {
            let xDiff = obj1.x - obj2.x;
            let yDiff = obj1.y - obj2.y;
            return (xDiff * xDiff) + (yDiff * yDiff);
        }

        // Draw Loop (once per frame)
        // temporarily commenting
        // function drawStuff() {
        //     // Clear the canvas
        //     context.clearRect(0,0, canvas.width, canvas.height);

        //     ball.draw();

        //     for(let i = 0; i < fishes.length; i=i+1)
        //     {
        //         fishes[i].draw();
        //     }

        //     for(let i = 0; i < food.length; i=i+1)
        //     {
        //         food[i].draw();
        //     }

        //     // Get called again the next frame
        //     window.requestAnimationFrame(drawStuff);
        // }
        // Initiate the draw loop
        // window.requestAnimationFrame(drawStuff);

     
    </script>
</body>

</html>