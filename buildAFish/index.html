<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <link rel="icon" href="favicon.ico">
    <link rel="stylesheet" href="normalize.css">
    <title>Cthulhu Fish</title>

    <noscript>Hello Ryan! Behold the fallback fish: üêü</noscript>
    <link rel="stylesheet" href="styles/main.css">
    <style>
     #fishbox {
     } 
    </style>
</head>
<body>
    <div id="app">
        <!-- üêü üé£üê†üê°ü¶àüê≥üíßüåøü¶ëüêô -->
        <canvas id="fishbox" width="500" height="500" tabindex='0'></canvas>
        <!--<canvas id="fishbox" width="500" height="500" tabindex='0' :style="{filter: 'invert('+currFilter+')'}"></canvas> -->
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="alpine.3.9.6.min.js" defer></script>
    <script src="lodash.min.js"></script>
    <script src="chance.min.js"></script>
    <script type="text/javascript" src="voronoijs.min.js"></script>
    <script>

         document.addEventListener('alpine:init', () => {
             Alpine.data('d', () => ({
        //         currFilter: 0,

        //         init() {
        //             setInterval(() => {
        //                 this.currFilter = (Math.sin(Date.now()/10)+1)/2
        //             }, 100);
        //         }
             }))
         });
        
        $(document).ready(function() {
            var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
            window.requestAnimationFrame = requestAnimationFrame;
            var canvas = document.getElementById("fishbox");
            var context = canvas.getContext("2d");
            console.log("Game started...")
            loop();
        })
        

        var curKeyPress = {};

        var balls = []
        var numBalls = 10

        var healthBar = {
            x: 20,
            y: 20,
            width: 150,
            height: 30,
            draw: function(context) {
                // Outer Rectangle outline
                context.save();
                context.strokeWidth = 3;
                context.strokeRect(this.x, this.y, this.width, this.height);
                context.restore();

                // Inner Rectangle health bar
                context.save();
                context.fillStyle = 'red';
                context.fillRect(this.x+1, this.y+1, (this.width-2) * (ball.health / 100), this.height-2);
                context.restore();
            }
        }

        var colors = ['dodgerblue', 'green', 'yellow', 'black', 'red', 'purple', 'pink']

        for(let i = 0; i < numBalls; i=1+i) {
            balls.push(
                {
                    x: Math.floor(Math.random() * 500),
                    y: Math.floor(Math.random() * 500),
                    radius: Math.floor(Math.random() * 20),
                    velX: 0,
                    velY: 0,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    draw: function(context) {
                        context.beginPath();
                        context.arc(this.x, this.y, this.radius, 0, Math.PI * 2, true);
                        context.closePath();
                        context.fillStyle = this.color;
                        context.fill();
                    }
                }
            )
        }
        
    
        
        var ball = {
            x: 50,
            y: 50,
            radius: 20,
            velX: 0,
            velY: 0,
            health: 75,
            plastic: 2,
            color: 'green',
            draw: function(context) {
                context.beginPath();
                context.arc(this.x, this.y, this.radius, 0, Math.PI * 2, true);
                context.closePath();
                context.fillStyle = this.color;
                context.fill();
            }
        }


        $(document).on('keydown', function(e) {
            curKey = String.fromCharCode(e.which)
            curKeyPress[curKey.toLowerCase()] = true;
        })

        $(document).on("keyup", function(e) {
            curKey = String.fromCharCode(e.which)
            curKeyPress[curKey.toLowerCase()] = false;
        })

        function updateKeyStatus() {
            if(curKeyPress['w']){
                ball.velY = -0.8;
            }
            else if(curKeyPress['s']) {
                ball.velY = 0.8;
            }
            else {
                ball.velY = 0;
            }
            if(curKeyPress['a']) {
                ball.velX = -0.8;
            }
            else if(curKeyPress['d']) {
                ball.velX = 0.8;
            }
            else {
                ball.velX = 0;
            }
        }
        
        function loop() {
            updateKeyStatus();
            var canvas = document.getElementById("fishbox");
            var context = canvas.getContext("2d");
            
            context.clearRect(0,0, canvas.width, canvas.height);
            
            var deltaX = ball.velX
            var deltaY = ball.velY
            
            //console.log(curKeyPress)
            
            ball.x += deltaX;
            ball.y += deltaY;

            if(ball.plastic > 0) {
                // /60 to make it per second probably
                ball.health -= (ball.plastic * 2) / 60;

                if(Math.random() < 0.0045) {
                    ball.plastic = ball.plastic - 1;
                }
            }

            for(let i = 0; i < food.length; i++)
            {
                if (isColliding(food[i], ball)) {
                    if(food[i].isSafe) {
                        ball.health = ball.health + 5;
                    }
                    else {
                        ball.plastic = ball.plastic + 1;
                    }
                    foog = food.splice(i, 1);
                    i = i - 1;
                }
                else {
                    food[i].draw(context)
                }
            }

            context.font = '50px serif';
            context.fillText('ü¶ê', 60, 60);

            ball.draw(context);

            for (let i = 0; i < balls.length; i++) {

                var thresh = 100
                
                var ballsWithinThresh = []
                for (let j = i + 1; j < balls.length; j++) {
                    if (getDist(balls[i], balls[j]) <= thresh) {
                        ballsWithinThresh.push(balls[j])
                    }
                }

                var averagePoint = []
                

                var dir = Math.random() < 0.25 ? -1 : 1;

                var deltaX = (ball.x - balls[i].x) * 0.0025
                var deltaY = (ball.y - balls[i].y) * 0.0025

            
                balls[i].x += deltaX
                balls[i].y += deltaY
                balls[i].draw(context)
            }

            healthBar.draw(context);

            requestAnimationFrame(loop);
        }
        
    
        var fishes = []
        var food = []
        addFish('./resources/images/fish_1_cropped.png');
        addFood();
        addFood();
        addFood();
        addFood();
        addFood();
        addFood();

        function addFood() {
            new_food = {
                x: Math.floor((Math.random() * 500)),
                y: Math.floor((Math.random() * 500)),
                color: 'brown',
                radius: 5,
                isSafe: (Math.random() > 0.5),
                draw: function(context) {
                    context.beginPath();
                    context.arc(this.x, this.y, this.radius, 0, Math.PI * 2, true);
                    context.closePath();
                    context.fillStyle = this.color;
                    context.fill();
                }
            }
            food.push(new_food);
        }

        function getVector(org, dest) {
            return [[dest.x - org.x], [dest.y - org.y]]
        }

        function getDist(b1, b2) {
            return Math.sqrt(Math.pow(b1.x - b2.x, 2) + Math.pow(b1.y - b2.y, 2))
        }

        function getBallsWithinThresh(org, balls, thresh) {
            var ret = []
            for (var i = 0; i < balls.length; i++) {
                if (getDist(org, balls[i]) <= thresh) {
                    ret.push(balls[i])
                }
            }
            return ret
        }

        function addFish(fishImg) {
            fish_img = new Image();
            fish_img.onload = function() {
                new_fish = {
                    x: 100,
                    y: 100,
                    img: fishImg,
                    draw: function() {
                        context.drawImage(fish_img, this.x, this.y);
                    }
                }
                fishes.push(new_fish);
            };
            fish_img.onerror = function() {
                console.log("Error loading fish image");
            };
            fish_img.src = fishImg;
        }

        // Assumes everything is a circle with a radius attribute and x/y coordinates
        function isColliding(obj1, obj2) {
            let sqrDistance = sqrDist(obj1, obj2);
            let combinedRadius = obj1.radius + obj2.radius;
            // A^2 + B^2 = C^2
            // Get the square distance between two objects (C^2)
            // Then see if it's larger than the combined object radiuses squared
            if(sqrDistance < (combinedRadius * combinedRadius)) {
                return true;
            }
            return false;
        }

        // Gets the squared distance between two objects
        // A^2 + B^2 = C^2
        function sqrDist(obj1, obj2) {
            let xDiff = obj1.x - obj2.x;
            let yDiff = obj1.y - obj2.y;
            return (xDiff * xDiff) + (yDiff * yDiff);
        }

        // Draw Loop (once per frame)
        // temporarily commenting
        // function drawStuff() {
        //     // Clear the canvas
        //     context.clearRect(0,0, canvas.width, canvas.height);

        //     ball.draw();

        //     for(let i = 0; i < fishes.length; i=i+1)
        //     {
        //         fishes[i].draw();
        //     }

        //     for(let i = 0; i < food.length; i=i+1)
        //     {
        //         food[i].draw();
        //     }

        //     // Get called again the next frame
        //     window.requestAnimationFrame(drawStuff);
        // }
        // Initiate the draw loop
        // window.requestAnimationFrame(drawStuff);

     
    </script>
</body>

</html>